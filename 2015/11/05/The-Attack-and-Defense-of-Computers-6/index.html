<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>The Attack and Defense of Computers-6 | Justice Shadower</title>
  <meta name="description" content="This world around you is not what it seems." />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/component.css" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <meta name="generator" content="Justice Shadower">
  <script src="http://static.duoshuo.com/embed.js"></script>
  
  
  

  

</head>
<body>
<div class="container">
    <div class="mp-pusher" id="mp-pusher">
        <i id="scroll-up" class="fa fa-angle-up"></i>
        <nav id="mp-menu" class="mp-menu">
            <div class="mp-level">
                <a data-pjax class="back-home" style="font-size: 20px" href="/"><h2 ><i class="fa fa-home"></i>
                        Home</h2></a>
                <ul class="first-level">
                    <li>
                        <a class="fa fa-archive" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Archive</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-archive"></i>
                                Archive</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-archive" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/15/Linux-Operating-System-7/">Linux Operating System-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/08/The-Attack-and-Defense-of-Computers-7/">The Attack and Defense of Computers-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/07/Applied-Cryptography-7/">Applied Cryptography-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/05/The-Attack-and-Defense-of-Computers-6/">The Attack and Defense of Computers-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/01/Linux-Operating-System-6/">Linux Operating System-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/28/Applied-Cryptography-6/">Applied Cryptography-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/26/Linux-Operating-System-5/">Linux Operating System-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/25/The-Attack-and-Defense-of-Computers-5/">The Attack and Defense of Computers-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/21/Applied-Cryptography-5/">Applied Cryptography-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/18/Linux-Operating-System-4/">Linux Operating System-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">The Attack and Defense of Computers-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/17/Applied-Cryptography-4/">Applied Cryptography-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/16/Linux-Operating-System-3/">Linux Operating System-3</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/15/Linux-Operating-System-2/">Linux Operating System-2</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/14/Linux-Operating-System-1/">Linux Operating System-1</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/">The Attack and Defense of Computers (1~3)</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/10/Applied-Cryptography-3/">Applied Cryptography-3</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/09/29/Applied-Cryptography-2/">Applied Cryptography-2</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/09/28/Applied-Cryptography-1/">Applied Cryptography-1</a>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-copy" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Categories</a>

                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-copy"></i>
                                Categories</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-category" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-tags" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Tags</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-tags"></i>
                                Tags</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-tag" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Applied-Cryptography/">&nbsp;&nbsp;&nbsp;Applied Cryptography</a>
                                    <small>7</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Linux-Operating-System/">&nbsp;&nbsp;&nbsp;Linux Operating System</a>
                                    <small>7</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/The-Attack-and-Defense-of-Computers/">&nbsp;&nbsp;&nbsp;The Attack and Defense of Computers</a>
                                    <small>5</small>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    
                    <li class="mp-pjax"><a class="fa fa-user" href="http://adl.tw/~eastl/" target="_blank">&nbsp;&nbsp;&nbsp;About me</a></li>
                    <li><a class="fa fa-github" href="https://github.com/EastL" target = "_blank">&nbsp;&nbsp;&nbsp;Github</a></li>

                </ul>

            </div>
        </nav>
        <div id="pjax">
            <div class="pjax-hidden" style="display: none">
                
                    <a  data-pjax href="/2015/11/15/Linux-Operating-System-7/">Linux Operating System-7</a>
                
                    <a  data-pjax href="/2015/11/08/The-Attack-and-Defense-of-Computers-7/">The Attack and Defense of Computers-7</a>
                
                    <a  data-pjax href="/2015/11/07/Applied-Cryptography-7/">Applied Cryptography-7</a>
                
                    <a  data-pjax href="/2015/11/05/The-Attack-and-Defense-of-Computers-6/">The Attack and Defense of Computers-6</a>
                
                    <a  data-pjax href="/2015/11/01/Linux-Operating-System-6/">Linux Operating System-6</a>
                
                    <a  data-pjax href="/2015/10/28/Applied-Cryptography-6/">Applied Cryptography-6</a>
                
                    <a  data-pjax href="/2015/10/26/Linux-Operating-System-5/">Linux Operating System-5</a>
                
                    <a  data-pjax href="/2015/10/25/The-Attack-and-Defense-of-Computers-5/">The Attack and Defense of Computers-5</a>
                
                    <a  data-pjax href="/2015/10/21/Applied-Cryptography-5/">Applied Cryptography-5</a>
                
                    <a  data-pjax href="/2015/10/18/Linux-Operating-System-4/">Linux Operating System-4</a>
                
                    <a  data-pjax href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">The Attack and Defense of Computers-4</a>
                
                    <a  data-pjax href="/2015/10/17/Applied-Cryptography-4/">Applied Cryptography-4</a>
                
                    <a  data-pjax href="/2015/10/16/Linux-Operating-System-3/">Linux Operating System-3</a>
                
                    <a  data-pjax href="/2015/10/15/Linux-Operating-System-2/">Linux Operating System-2</a>
                
                    <a  data-pjax href="/2015/10/14/Linux-Operating-System-1/">Linux Operating System-1</a>
                
                    <a  data-pjax href="/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/">The Attack and Defense of Computers (1~3)</a>
                
                    <a  data-pjax href="/2015/10/10/Applied-Cryptography-3/">Applied Cryptography-3</a>
                
                    <a  data-pjax href="/2015/09/29/Applied-Cryptography-2/">Applied Cryptography-2</a>
                
                    <a  data-pjax href="/2015/09/28/Applied-Cryptography-1/">Applied Cryptography-1</a>
                
                
                
                    <a data-pjax href="/tags/Applied-Cryptography/">&nbsp;&nbsp;Applied Cryptography</a>
                
                    <a data-pjax href="/tags/Linux-Operating-System/">&nbsp;&nbsp;Linux Operating System</a>
                
                    <a data-pjax href="/tags/The-Attack-and-Defense-of-Computers/">&nbsp;&nbsp;The Attack and Defense of Computers</a>
                
                <a data-pjax class="fa fa-user" href="http://adl.tw/~eastl/" target="_blank">&nbsp;&nbsp;&nbsp;About me</a>
            </div>
            <nav class="nexus">
                <li  style="border-left: 1px solid #c6d0da;">
                    <a id="trigger" href="#"><i class="fa fa-bars"></i></a>
                </li>
                <li ><a id="nexus-back" data-pjax href="/">Justice Shadower</a></li>
                
                <div id="nav-container">
                    <div class="post-navbar" style="line-height: 63px;display:none">
                        <li id="navbar-title"><a href="#">The Attack and Defense of Computers-6</a></li>
                        <li id="navbar-toc" style="border-left: none">
                            <a style="padding-right: 15px">
                                <span id="toc-content" >Introduction</span><i class="fa fa-chevron-down" ></i>
                            </a>
                            <div class="hidden-box">
                                <ul id="toc"></ul>
                            </div>
                        </li>
                    </div>
                </div>
                
            </nav>

            <div class="scroller">
            <div class="scroller-inner">


<!-- -->
<!--<body class="post-template">-->
<!---->
  

<main class="content" role="main">
    <article class="post" >
    <span class="post-meta">
                  <div class="tag-tile">
                      
                      
                      <a data-pjax href='/tags/The-Attack-and-Defense-of-Computers/' style='color:#D5D5D5'>The Attack and Defense of Computers</a>
                      
                      
                  </div>
                <h1 class="post-title" style="margin: 14px 0;color:#50585D">The Attack and Defense of Computers-6</h1>

                    <div class="post-meta">
                        Post on<span class="fa fa-clock-o"></span>
                        <time datetime="2015-11-05T01:30:33.000Z"
                              itemprop="datePublished">2015-11-05</time>
                    </div>
    </span>

        <section class="post-content">
            <p>來源：<a href="http://www.csie.ncu.edu.tw/~hsufh/COURSES/FALL2015/2_BOA.ppt" target="_blank" rel="external">Drive-by Download(83 ~ 106)</a>，<a href="http://www.csie.ncu.edu.tw/~hsufh/COURSES/FALL2015/2_1_Botnet.ppt" target="_blank" rel="external">Botnet(1 ~ 10)</a></p>
<p></p><h2> Heap Spray </h2><br>Heap spray主要概念就是在受害程式的heap段注入大量的shellcode以及nop，這項技術是由SkyLined所提出，他利用heap spray打下了IE的許多漏洞，例如<a href="http://www.microsoft.com/technet/security/Bulletin/MS04-040.mspx" target="_blank" rel="external">MS04-040</a>以及<a href="http://www.microsoft.com/technet/security/Bulletin/MS05-020.mspx" target="_blank" rel="external">MS05-020</a>。下圖為Heap spray概念圖(來源<a href="http://sf-freedom.blogspot.tw/2006/06/heap-spraying-introduction.html" target="_blank" rel="external">Software Vulnerability Exploitation Blog</a>)：<p></p>
<p><img src="/images/heap_spray.jpg" alt=""></p>
<p>首先受害程式必須要有可以注入heap段的地方，我們所注入的程式必須在user space的heap段當中，圖中可以看到是在0x7fffffff以下，這邊是因為在windows環境，memory有一半是user space，而所注入的程式碼為nop+shellcode，如此一來再配合其他手段，將程式流程導向heap段變能發起攻擊。</p>
<p>實際要攻擊web的話可以利用Javascript的字串，就跟buffer overflow有點像，將javascript的string塞爆蓋到heap段為止。在Adobe Flash裡面也可以利用ActionScript來達到heap spray。下面為Javascript heap spray程式碼：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">SCRIPT</span> <span class="attribute">language</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">  shellcode = <span class="built_in">unescape</span>(<span class="string">"%u4343%u4343%..."</span>);</span><br><span class="line">  oneblock = <span class="built_in">unescape</span>(<span class="string">"%u0D0D%u0D0D"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> fullblock = oneblock;</span><br><span class="line">  <span class="keyword">while</span> (fullblock.length&lt;<span class="number">0x40000</span>) &#123;</span><br><span class="line">      fullblock += fullblock;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sprayContainer = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</span><br><span class="line">      sprayContainer[i] = fullblock + shellcode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><span class="tag">&lt;/<span class="title">SCRIPT</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面可以看到注入的東西為shellcode以及NOP，整個注入的大小大概是262MB。因此ASLR在這邊對攻擊者而言影響不大。(參考<a href="http://research.microsoft.com/pubs/76528/tr-2008-176.pdf" target="_blank" rel="external">Nozzle: A Defense Against Heap-spraying Code Injection Attacks</a>)     </p>
<p>而現在我們常用的影像檔案也可以拿來當作heap spray攻擊媒介，由於讀取影像檔的程式是動態讀取影像大小，因為影像檔大小無法預測，故我們可以依照讀取影像程式的寫法來塞heap spray到影像檔當中，這樣在受害者開起影像時就能將程式碼注入到開起影像的程式的heap段了。</p>
<p></p><h2> Memory Corruption Exploit </h2><br>講完heap spray後接下來看如何將程式流程導向heap段當中。第一種方法為Mishandling Tag Attribute Values，他是利用tag的屬性來讓memory crash。攻擊者可以自己加一段iframe，這個iframe大小為0因此受害者看不到，接著在裡面的屬性填上大量的字元，使得瀏覽器在執行抓取tag時造成memory corruption。範例如下：<p></p>
<p><img src="/images/mishandling_tag_value.jpg" alt=""></p>
<p>圖中可以看到攻擊者在src以及name裡面塞了大量的字元，而塞完結果導致eip停在0x769f682f，代表我們塞的字串蓋到了return address，使得程式流程導向了非法的記憶體位置，因此我們便可利用這點加上一些denug工具，將程式流程導向我們剛剛所注入的heap段當中，變能完成攻擊。</p>
<p></p><h4> Virtual Table </h4><br>我們也能利用Virtual Table 來達成攻擊。Virtual Table是用來儲存一些function位置，在call一些lib時可以先到此table查詢function位置，然後再到function的真正位置，C裡面的GOT就是此類型的table。我們在overflow時可以將指向table的值蓋成我們自己的table，接著table裡面再去指向我們的heap spray段，如此便能達到攻擊者想要的流程：<p></p>
<p><img src="/images/virtual_table.jpg" alt=""></p>
<p>上圖可以看到我們利用a[100]來蓋掉vptr，因此程式流程導向我們的table最後到達heap spray。</p>
<p></p><h2> Drive-by Download Attacks  </h2><br>現在惡意程式樣貌非常多元，但大致可分為感染跟攻擊這兩種階段， Drive-by Download為目前非常流行的感染途徑，他可能利用網頁漏洞、email之類的讓使用者感染攻擊者的程式碼，當使用者瀏覽網頁或者觀看html格式的信件時都可能中毒。在感染過程中，大多攻擊者都不想讓受害者發現自己的攻擊碼，因此隱藏的越隱蔽越好，下圖為Drive-by Download Attacks示意圖：<p></p>
<p><img src="/images/Drive-by_download_attack.jpg" alt=""></p>
<p>攻擊者在正常網站上加入了自己的攻擊程式碼，讓受害者在瀏覽網頁時會自動導向攻擊者的網站，圖中可以看到在正常網站裡安插了iframe，長寬為0，因此受害者會在不知不覺中向攻擊者網站拿了惡意的html。</p>
<p><img src="/images/Drive-by_download_attack2.jpg" alt=""></p>
<p><img src="/images/Drive-by_download_attack3.jpg" alt=""></p>
<p>接著這個惡意的html裡面有16進位執行碼，他會透過受害者的瀏覽器向攻擊者網站下載惡意執行檔存到硬碟當中。在這過程當中攻擊者將受害者導向自己的網站就是為了不被原來網站發現，如果要直接在最剛開始的網頁中下載惡意程式也是可以，不過相對的所需要的程式碼就比較長，易被發現。</p>

        </section>
        <hr/>
        <nav class="pagination" style="width:auto" role="pagination">
            
            <a data-pjax class="newer-posts" href="/2015/11/07/Applied-Cryptography-7/">← Prev Post</a>
            
            <a class="share-button" data-original-title title>Share this Post</a>
            
            <a data-pjax class="older-posts" href="/2015/11/01/Linux-Operating-System-6/">Next Post →</a>
            
        </nav>
        <br/>
        <br/>
        <section id="comment">
            <div id="comment-box"></div>
        </section>


    </article>
</main>


  
<footer class="site-footer">
    
    <div class="inner">
        <section class="copyright"><a href="/"></a> &copy; Justice Shadower 2014</section>
        <section class="poweredby">Published with <a target="_blank" href="http://hexo.io/">Hexo   </a> and Theme by <a target="_blank" href="https://github.com/yuche/hexo-theme-kael">Kael</a></section>
    </div>
</footer>
</div>
</div><!-- /scroller -->

</div><!-- /pusher -->
</div><!-- /container -->
</div>

<!-- Easter eggs -->

<div class="egg animated">
    <a id="close-button" href="#">X</a>
    <div class="block">
        <div class="loading">
            <span class="ball1"></span>
            <span class="ball2"></span>
        </div>
    </div>
</div>
  
<script src="//cdn.staticfile.org/jquery/1.11.0/jquery.min.js"></script>
<script>
    if (!window.jQuery) {
        var script = document.createElement('script');
        script.src = "/js/jquery.min.js";
        document.body.appendChild(script);
    }
</script>
<script type="text/javascript" src="/js/lib.js"></script>
<script type="text/javascript" src="/js/main.js"></script>




<script type="text/javascript">
    var disqus_shortname = 'EastL';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




</body>
</html>
