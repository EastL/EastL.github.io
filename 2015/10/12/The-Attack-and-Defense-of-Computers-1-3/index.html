<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>The Attack and Defense of Computers (1~3) | Justice Shadower</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="來源：Malware: Logic Bombs, Key Logger, URL Injection, Browser Hijackers, Trojan Horses, and Spyware，Internet Worms, Buffer Overflow Attacks, and Heap Overflow Attacks (1~20)
由於前兩次上課名詞解釋部分較多，這邊做筆記感覺也是把投影">
<meta property="og:type" content="article">
<meta property="og:title" content="The Attack and Defense of Computers (1~3)">
<meta property="og:url" content="http://eastl.github.io/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/index.html">
<meta property="og:site_name" content="Justice Shadower">
<meta property="og:description" content="來源：Malware: Logic Bombs, Key Logger, URL Injection, Browser Hijackers, Trojan Horses, and Spyware，Internet Worms, Buffer Overflow Attacks, and Heap Overflow Attacks (1~20)
由於前兩次上課名詞解釋部分較多，這邊做筆記感覺也是把投影">
<meta property="og:image" content="http://eastl.github.io/images/code_memory.jpg">
<meta property="og:image" content="http://eastl.github.io/images/add_od.jpg">
<meta property="og:image" content="http://eastl.github.io/images/cvsas.jpg">
<meta property="og:image" content="http://eastl.github.io/images/sf.jpg">
<meta property="og:image" content="http://eastl.github.io/images/sf_attack.jpg">
<meta property="og:image" content="http://eastl.github.io/images/buf_offset.jpg">
<meta property="og:updated_time" content="2015-10-13T03:39:38.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Attack and Defense of Computers (1~3)">
<meta name="twitter:description" content="來源：Malware: Logic Bombs, Key Logger, URL Injection, Browser Hijackers, Trojan Horses, and Spyware，Internet Worms, Buffer Overflow Attacks, and Heap Overflow Attacks (1~20)
由於前兩次上課名詞解釋部分較多，這邊做筆記感覺也是把投影">
<meta name="twitter:creator" content="@coolwuxing">
  
    <link rel="alternative" href="/atom.xml" title="Justice Shadower" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/cube.jpg">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-43935113-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <div id="header">
  <div id="banner">
    <div id="cover"></div>
    <div id="stars"></div>
  </div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Justice Shadower</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">This world around you is not what it seems.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://eastl.github.io"></form>
      </div>
    </div>
  </div>
</div>
      <div class="outer">
        <section id="main"><article id="post-The-Attack-and-Defense-of-Computers-1-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/" class="article-date">
  <time datetime="2015-10-12T13:06:59.000Z" itemprop="datePublished">2015-10-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      The Attack and Defense of Computers (1~3)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>來源：<a href="http://www.csie.ncu.edu.tw/~hsufh/COURSES/FALL2015/1_malware.ppt" target="_blank" rel="external">Malware: Logic Bombs, Key Logger, URL Injection, Browser Hijackers, Trojan Horses, and Spyware</a>，<a href="http://www.csie.ncu.edu.tw/~hsufh/COURSES/FALL2015/2_BOA.ppt" target="_blank" rel="external">Internet Worms, Buffer Overflow Attacks, and Heap Overflow Attacks (1~20)</a></p>
<p>由於前兩次上課名詞解釋部分較多，這邊做筆記感覺也是把投影片再抄一次(汗…<br>所以就從第三堂課開始~~(絕對不是偷懶XDD</p>
<p></p><h2> Buffer Overflow Attacks </h2><p></p>
<p></p><h4> Stack Smashing attacks </h4><br>Stack Smashing attacks 簡單來說就是你預先寫好一段程式碼，然後將它放到正在執行的程式的stack裡，再利用正常流程會執行到的function，將它的return address換成你剛剛放進的位置。聽起來好像有點複雜，這邊一步一步講解。<p></p>
<p>首先要先了解電腦中正在執行的程式在記憶體裡面是長什麼樣子。以下的例子環境是在linux 32bit的OS上：</p>
<p><img src="/images/code_memory.jpg" alt="圖一"></p>
<p>上圖左半部是程式的原始C檔，右邊是process正在執行時記憶體內容(注意這邊記憶體位置不是實體位置)，由於此攻擊是針對stack，所以要先懂stack(紫色區域)跟code(紅色區域)這兩塊在幹嘛。<br>當你編譯C程式成為執行檔，它會先轉成組合語言再變成binary，而那些binary就放在紅色框框的code裡面。而你所寫的程式轉成組合語言後，基本上做的事情就是一直存取stack，所以stack上放的東西是你要執行時會用到的資料。當你開始執行程式時，code段裡面會有eip指著你現在執行到哪一行指令，stack段會有esp指著stack目前的頂端。下面我寫一個簡單的C程式：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> w;</span><br><span class="line"><span class="keyword">int</span> x;</span><br><span class="line"><span class="keyword">int</span> y = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">int</span> z = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addTwoValues</span><span class="params">(<span class="keyword">int</span> first, <span class="keyword">int</span> second)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> first + second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    w = <span class="number">1</span>;</span><br><span class="line">    x = <span class="number">2</span>;</span><br><span class="line">    y = <span class="number">3</span>;</span><br><span class="line">    z = <span class="number">4</span>;</span><br><span class="line">    z = addTwoValues(w, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>這裡宣告了四個global變數，然後main function裡面對這四個變數assign值後呼叫了addTwoValues function。接下來將此檔案編譯成執行檔用objdump -d來看：</p>
<p><img src="/images/add_od.jpg" alt="objdump file"></p>
<p>我只擷取了main function，最左邊(紅色)那排是程式碼所在的位置，也就是圖一中code那個地方，中間那欄(藍色)就是code裡面放的內容，由於binary不易閱讀，objdump很好心的幫我們翻譯成組合語言，在右邊那欄(黃色)。這邊可以看到組合語言做的事情都是在記憶體位置以及暫存器之間搬動值，而所有的push、pop以及接下來call的function都在stack裡面。<br>這邊額外補充一下老師所講的global變數儲存位置，在linux中C如果宣告了global變數，有初始值的會被放在圖一中的data段，沒有初始的會被放在bss段(BlockStarted by Symbol)，可以看一下剛剛的程式，w跟x沒有初始值，y跟z有初始值：</p>
<p><img src="/images/cvsas.jpg" alt=""></p>
<p>在原始C檔的main function裡，w,x,y,z分別assign了1,2,3,4，對應到組語可以看到有四個記憶體位置被放置了1,2,3,4。上圖中可以看到，w跟x是連續記憶體，但y開始並沒有連續下去，代表y跟z被放到另一個區段。會區分這兩個區段是因為沒有初始值的變數c compiler並不會將它存在執行檔裡，不然當你宣告了很多變數沒有初始值，而這些又要存在執行檔的話，執行檔會變的超大。</p>
<p>接下來看stack frame裡面長什麼樣子，下圖中G function裡呼叫了H function，H function裡面可以讓使用者輸入字串。右邊的圖是在使用者輸入了abc之後產生的stack frame，最上面是G function的stack frame，接下來的b是G function push的參數要給H function用的，接著是return address，這邊的return address是給code段的eip用的，它裡面存的是G function裡呼叫H function之後下一行指令的位置，以這張圖來講就是add_g這個tag的位置，當H function執行完畢後eip才知道要回到哪行指令繼續執行下去。接下來就是ebp，ebp裡面存的位置是上一個呼叫此function的ebp，由於stack執行完後會有回收的動作，H function被回收掉時需要知道上一個ebp位置，而ebp暫存器又只有一個，所以就將它存在這個地方。ebp之後就是H function的local變數，首先是100個字元陣列c，這邊注意的是，雖然stack是由高位置往低位置長，但是local變數的低位置一樣是在低位置的地方，所以c[0]是在最下方，裡面存的是使用者輸入的a，以此類推a的上面是b，接著是c。最後是integer i的位置，目前這個位置是stack的頂端，所以esp會指著這個地方。</p>
<p><img src="/images/sf.jpg" alt="stack frame"></p>
<p>了解stack frame長什麼樣子後，接下來看如何攻擊，當使用者不是像剛剛那樣乖乖的輸入合法字串，而是輸入超過指定範圍的字串，也就是超過c陣列定義的100byte，輸入的資訊會在stack裡面繼續往上長，也就是會蓋掉剛剛所講的ebp，接下來蓋掉return address，此時H function執行完畢後會執行return address裡面存的位置的指令，如果使用者是隨意輸入的話他會找不到位置，然後就segment fault，但如果攻擊者是輸入將要執行的攻擊碼位置，那執行完H function後就會跳到攻擊者要執行的程式了。</p>
<p><img src="/images/sf_attack.jpg" alt="stack smashing attack"></p>
<p>上圖可以看到攻擊者先輸入一段Injected Code，之後在return address的地方輸入Injected Code的位置，攻擊便能執行。通常攻擊者會想辦法拿到shell，這樣之後才能做更多事情，所以Injected Code通常都是執行shell居多，而執行shell是以這支受害程式的權限去執行的，所以當此受害程式有root權限時，攻擊者就能夠利用此漏洞拿到root shell了。通常server上會掛一些程式，這些程式會提供使用者輸入，攻擊者會利用剛剛所講的漏洞執行shell並將它導到socket連回自己電腦，這樣就可以遠端拿到server的控制權。</p>
<p>但此攻擊會遇到一個問題，攻擊者輸入的資訊是在stack上的某個變數，要如何知道這個變數距離return address多遠？如果攻擊者有受害程式的原始碼也是沒用的，因為大多數compiler都不會按照原始碼宣告變數的順序來排stack上的順序，再來，如果攻擊者擁有原始執行檔也是沒用的，server上執行時的stack可能跟你local執行時的stack長的不一樣，所以該如何知道變數跟return address的offset呢？</p>
<p><img src="/images/buf_offset.jpg" alt="buffer offset"></p>
<p>為了解決此問題，可以在快接近return address時，重複return address，雖然我不知道正確位置，但總有一個會蓋到真正的return address吧？再來我到底要從什麼地方開始注入我的攻擊碼呢？有一個東西叫做NOP，它的代碼是0x90，它做的事情是不做任何事情跳到下一行指令，這下好辦拉，我可以在我的攻擊碼前面加一堆NOP，這樣我的return address只要跳到這堆NOP，就可以一路滑到我的攻擊代碼了。因為之後防禦者知道有這種攻擊，在偵測病毒時會偵測有無0x90，攻擊者因而發展出其他的NOP sled，像是0x41、0x43，或者是mutiple byte的，像是0x0d0d0d0d，它做的事情是跟暫存器eax做or，對攻擊者來說也算沒做事情，加一堆0x0d後最後再補幾個NOP就能到達攻擊者的攻擊程式了。這邊有個<a href="https://www.onlinedisassembler.com/odaweb/" target="_blank" rel="external">網站</a>可以將十六進位碼轉成組合語言。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://eastl.github.io/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/" data-id="cig5t6e9400064ronllvm14kx" class="article-share-link">Share</a>
      
        <a href="http://eastl.github.io/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/The-Attack-and-Defense-of-Computers/">The Attack and Defense of Computers</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/10/14/Linux-Operating-System-1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Linux Operating System-1
        
      </div>
    </a>
  
  
    <a href="/2015/10/10/Applied-Cryptography-3/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Applied Cryptography-3</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Applied-Cryptography/">Applied Cryptography</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Operating-System/">Linux Operating System</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/The-Attack-and-Defense-of-Computers/">The Attack and Defense of Computers</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Applied-Cryptography/" style="font-size: 20px;">Applied Cryptography</a> <a href="/tags/Linux-Operating-System/" style="font-size: 15px;">Linux Operating System</a> <a href="/tags/The-Attack-and-Defense-of-Computers/" style="font-size: 10px;">The Attack and Defense of Computers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/10/21/Applied-Cryptography-5/">Applied Cryptography-5</a>
          </li>
        
          <li>
            <a href="/2015/10/18/Linux-Operating-System-4/">Linux Operating System-4</a>
          </li>
        
          <li>
            <a href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">The Attack and Defense of Computers-4</a>
          </li>
        
          <li>
            <a href="/2015/10/17/Applied-Cryptography-4/">Applied Cryptography-4</a>
          </li>
        
          <li>
            <a href="/2015/10/15/Linux-Operating-System-2/">Linux Operating System-2</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <div id="footer">
  
  <div id='foot-stars'></div>
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 EastL<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</div>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'EastL';
  
  var disqus_url = 'http://eastl.github.io/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>