<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Linux Operating System-5 | Justice Shadower</title>
  <meta name="description" content="This world around you is not what it seems." />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/component.css" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <meta name="generator" content="Justice Shadower">
  <script src="http://static.duoshuo.com/embed.js"></script>
  
  
  

  

</head>
<body>
<div class="container">
    <div class="mp-pusher" id="mp-pusher">
        <i id="scroll-up" class="fa fa-angle-up"></i>
        <nav id="mp-menu" class="mp-menu">
            <div class="mp-level">
                <a data-pjax class="back-home" style="font-size: 20px" href="/"><h2 ><i class="fa fa-home"></i>
                        Home</h2></a>
                <ul class="first-level">
                    <li>
                        <a class="fa fa-archive" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Archive</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-archive"></i>
                                Archive</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-archive" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/15/Linux-Operating-System-7/">Linux Operating System-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/08/The-Attack-and-Defense-of-Computers-7/">The Attack and Defense of Computers-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/07/Applied-Cryptography-7/">Applied Cryptography-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/05/The-Attack-and-Defense-of-Computers-6/">The Attack and Defense of Computers-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/01/Linux-Operating-System-6/">Linux Operating System-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/28/Applied-Cryptography-6/">Applied Cryptography-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/26/Linux-Operating-System-5/">Linux Operating System-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/25/The-Attack-and-Defense-of-Computers-5/">The Attack and Defense of Computers-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/21/Applied-Cryptography-5/">Applied Cryptography-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/18/Linux-Operating-System-4/">Linux Operating System-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">The Attack and Defense of Computers-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/17/Applied-Cryptography-4/">Applied Cryptography-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/16/Linux-Operating-System-3/">Linux Operating System-3</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/15/Linux-Operating-System-2/">Linux Operating System-2</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/14/Linux-Operating-System-1/">Linux Operating System-1</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/">The Attack and Defense of Computers (1~3)</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/10/Applied-Cryptography-3/">Applied Cryptography-3</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/09/29/Applied-Cryptography-2/">Applied Cryptography-2</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/09/28/Applied-Cryptography-1/">Applied Cryptography-1</a>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-copy" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Categories</a>

                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-copy"></i>
                                Categories</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-category" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-tags" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Tags</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-tags"></i>
                                Tags</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-tag" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Applied-Cryptography/">&nbsp;&nbsp;&nbsp;Applied Cryptography</a>
                                    <small>7</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Linux-Operating-System/">&nbsp;&nbsp;&nbsp;Linux Operating System</a>
                                    <small>7</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/The-Attack-and-Defense-of-Computers/">&nbsp;&nbsp;&nbsp;The Attack and Defense of Computers</a>
                                    <small>5</small>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    
                    <li class="mp-pjax"><a class="fa fa-user" href="http://adl.tw/~eastl/" target="_blank">&nbsp;&nbsp;&nbsp;About me</a></li>
                    <li><a class="fa fa-github" href="https://github.com/EastL" target = "_blank">&nbsp;&nbsp;&nbsp;Github</a></li>

                </ul>

            </div>
        </nav>
        <div id="pjax">
            <div class="pjax-hidden" style="display: none">
                
                    <a  data-pjax href="/2015/11/15/Linux-Operating-System-7/">Linux Operating System-7</a>
                
                    <a  data-pjax href="/2015/11/08/The-Attack-and-Defense-of-Computers-7/">The Attack and Defense of Computers-7</a>
                
                    <a  data-pjax href="/2015/11/07/Applied-Cryptography-7/">Applied Cryptography-7</a>
                
                    <a  data-pjax href="/2015/11/05/The-Attack-and-Defense-of-Computers-6/">The Attack and Defense of Computers-6</a>
                
                    <a  data-pjax href="/2015/11/01/Linux-Operating-System-6/">Linux Operating System-6</a>
                
                    <a  data-pjax href="/2015/10/28/Applied-Cryptography-6/">Applied Cryptography-6</a>
                
                    <a  data-pjax href="/2015/10/26/Linux-Operating-System-5/">Linux Operating System-5</a>
                
                    <a  data-pjax href="/2015/10/25/The-Attack-and-Defense-of-Computers-5/">The Attack and Defense of Computers-5</a>
                
                    <a  data-pjax href="/2015/10/21/Applied-Cryptography-5/">Applied Cryptography-5</a>
                
                    <a  data-pjax href="/2015/10/18/Linux-Operating-System-4/">Linux Operating System-4</a>
                
                    <a  data-pjax href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">The Attack and Defense of Computers-4</a>
                
                    <a  data-pjax href="/2015/10/17/Applied-Cryptography-4/">Applied Cryptography-4</a>
                
                    <a  data-pjax href="/2015/10/16/Linux-Operating-System-3/">Linux Operating System-3</a>
                
                    <a  data-pjax href="/2015/10/15/Linux-Operating-System-2/">Linux Operating System-2</a>
                
                    <a  data-pjax href="/2015/10/14/Linux-Operating-System-1/">Linux Operating System-1</a>
                
                    <a  data-pjax href="/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/">The Attack and Defense of Computers (1~3)</a>
                
                    <a  data-pjax href="/2015/10/10/Applied-Cryptography-3/">Applied Cryptography-3</a>
                
                    <a  data-pjax href="/2015/09/29/Applied-Cryptography-2/">Applied Cryptography-2</a>
                
                    <a  data-pjax href="/2015/09/28/Applied-Cryptography-1/">Applied Cryptography-1</a>
                
                
                
                    <a data-pjax href="/tags/Applied-Cryptography/">&nbsp;&nbsp;Applied Cryptography</a>
                
                    <a data-pjax href="/tags/Linux-Operating-System/">&nbsp;&nbsp;Linux Operating System</a>
                
                    <a data-pjax href="/tags/The-Attack-and-Defense-of-Computers/">&nbsp;&nbsp;The Attack and Defense of Computers</a>
                
                <a data-pjax class="fa fa-user" href="http://adl.tw/~eastl/" target="_blank">&nbsp;&nbsp;&nbsp;About me</a>
            </div>
            <nav class="nexus">
                <li  style="border-left: 1px solid #c6d0da;">
                    <a id="trigger" href="#"><i class="fa fa-bars"></i></a>
                </li>
                <li ><a id="nexus-back" data-pjax href="/">Justice Shadower</a></li>
                
                <div id="nav-container">
                    <div class="post-navbar" style="line-height: 63px;display:none">
                        <li id="navbar-title"><a href="#">Linux Operating System-5</a></li>
                        <li id="navbar-toc" style="border-left: none">
                            <a style="padding-right: 15px">
                                <span id="toc-content" >Introduction</span><i class="fa fa-chevron-down" ></i>
                            </a>
                            <div class="hidden-box">
                                <ul id="toc"></ul>
                            </div>
                        </li>
                    </div>
                </div>
                
            </nav>

            <div class="scroller">
            <div class="scroller-inner">


<!-- -->
<!--<body class="post-template">-->
<!---->
  

<main class="content" role="main">
    <article class="post" >
    <span class="post-meta">
                  <div class="tag-tile">
                      
                      
                      <a data-pjax href='/tags/Linux-Operating-System/' style='color:#D5D5D5'>Linux Operating System</a>
                      
                      
                  </div>
                <h1 class="post-title" style="margin: 14px 0;color:#50585D">Linux Operating System-5</h1>

                    <div class="post-meta">
                        Post on<span class="fa fa-clock-o"></span>
                        <time datetime="2015-10-26T13:55:23.000Z"
                              itemprop="datePublished">2015-10-26</time>
                    </div>
    </span>

        <section class="post-content">
            <p>來源：<a href="http://www.csie.ncu.edu.tw/~hsufh/COURSES/FALL2015/linuxLecture_3_9-2.ppt" target="_blank" rel="external">Introduction and Memory Addressing: Segmentation Unit (80 ~ 100)</a>，<a href="http://www.csie.ncu.edu.tw/~hsufh/COURSES/FALL2015/linuxLecture_3_9-3.ppt" target="_blank" rel="external">Memory Addressing: Paging Unit (1 ~ 18)</a></p>
<p>由於現在的電腦都是多核心架構，一台電腦在run時不會只有一顆CPU，而接下來要講的GDT這個table每一顆CPU都會有一個GDT，因此在C語言有一種特殊的宣告方式：<a href="http://www.gelato.unsw.edu.au/archives/linux-ia64/0604/18078.html#start" target="_blank" rel="external">per-CPU</a>，他會將你宣告的值存在陣列當中，而這個陣列的個數就是你CPU的個數。</p>
<p><img src="/images/per_CPU_concept.jpg" alt=""></p>
<center> <a href="http://thinkiii.blogspot.tw/2014/05/a-brief-introduction-to-per-cpu.html" target="_blank" rel="external">per CPU</a> </center>

<p>而實際的<a href="http://lxr.cpsc.ucalgary.ca/lxr/linux+v3.9/arch/x86/kernel/cpu/common.c#L91" target="_blank" rel="external">GDT宣告</a>如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">DEFINE_PER_CPU_PAGE_ALIGNED(<span class="keyword">struct</span> gdt_page, gdt_page) = &#123; .gdt = &#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * We need valid kernel segments for data and code in long mode too</span><br><span class="line">         * IRET will check the segment types  kkeil 2000/10/28</span><br><span class="line">         * Also sysret mandates a special GDT layout</span><br><span class="line">         *</span><br><span class="line">         * TLS descriptors are currently at a different place compared to i386.</span><br><span class="line">         * Hopefully nobody expects them at a fixed place (Wine?)</span><br><span class="line">         */</span></span><br><span class="line">        [GDT_ENTRY_KERNEL32_CS]         = GDT_ENTRY_INIT(<span class="number">0xc09b</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_KERNEL_CS]           = GDT_ENTRY_INIT(<span class="number">0xa09b</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_KERNEL_DS]           = GDT_ENTRY_INIT(<span class="number">0xc093</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_DEFAULT_USER32_CS]   = GDT_ENTRY_INIT(<span class="number">0xc0fb</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_DEFAULT_USER_DS]     = GDT_ENTRY_INIT(<span class="number">0xc0f3</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_DEFAULT_USER_CS]     = GDT_ENTRY_INIT(<span class="number">0xa0fb</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">        [GDT_ENTRY_KERNEL_CS]           = GDT_ENTRY_INIT(<span class="number">0xc09a</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_KERNEL_DS]           = GDT_ENTRY_INIT(<span class="number">0xc092</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_DEFAULT_USER_CS]     = GDT_ENTRY_INIT(<span class="number">0xc0fa</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_DEFAULT_USER_DS]     = GDT_ENTRY_INIT(<span class="number">0xc0f2</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * Segments used for calling PnP BIOS have byte granularity.</span><br><span class="line">         * They code segments and data segments have fixed 64k limits,</span><br><span class="line">         * the transfer segment sizes are set at run time.</span><br><span class="line">         */</span></span><br><span class="line">        <span class="comment">/* 32-bit code */</span></span><br><span class="line">        [GDT_ENTRY_PNPBIOS_CS32]        = GDT_ENTRY_INIT(<span class="number">0x409a</span>, <span class="number">0</span>, <span class="number">0xffff</span>),</span><br><span class="line">        <span class="comment">/* 16-bit code */</span></span><br><span class="line">        [GDT_ENTRY_PNPBIOS_CS16]        = GDT_ENTRY_INIT(<span class="number">0x009a</span>, <span class="number">0</span>, <span class="number">0xffff</span>),</span><br><span class="line">        <span class="comment">/* 16-bit data */</span></span><br><span class="line">        [GDT_ENTRY_PNPBIOS_DS]          = GDT_ENTRY_INIT(<span class="number">0x0092</span>, <span class="number">0</span>, <span class="number">0xffff</span>),</span><br><span class="line">        <span class="comment">/* 16-bit data */</span></span><br><span class="line">        [GDT_ENTRY_PNPBIOS_TS1]         = GDT_ENTRY_INIT(<span class="number">0x0092</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="comment">/* 16-bit data */</span></span><br><span class="line">        [GDT_ENTRY_PNPBIOS_TS2]         = GDT_ENTRY_INIT(<span class="number">0x0092</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * The APM segments have byte granularity and their bases</span><br><span class="line">         * are set at run time.  All have 64k limits.</span><br><span class="line">         */</span></span><br><span class="line">        <span class="comment">/* 32-bit code */</span></span><br><span class="line">        [GDT_ENTRY_APMBIOS_BASE]        = GDT_ENTRY_INIT(<span class="number">0x409a</span>, <span class="number">0</span>, <span class="number">0xffff</span>),</span><br><span class="line">        <span class="comment">/* 16-bit code */</span></span><br><span class="line">        [GDT_ENTRY_APMBIOS_BASE+<span class="number">1</span>]      = GDT_ENTRY_INIT(<span class="number">0x009a</span>, <span class="number">0</span>, <span class="number">0xffff</span>),</span><br><span class="line">        <span class="comment">/* data */</span></span><br><span class="line">        [GDT_ENTRY_APMBIOS_BASE+<span class="number">2</span>]      = GDT_ENTRY_INIT(<span class="number">0x4092</span>, <span class="number">0</span>, <span class="number">0xffff</span>),</span><br><span class="line"></span><br><span class="line">        [GDT_ENTRY_ESPFIX_SS]           = GDT_ENTRY_INIT(<span class="number">0xc092</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        [GDT_ENTRY_PERCPU]              = GDT_ENTRY_INIT(<span class="number">0xc092</span>, <span class="number">0</span>, <span class="number">0xfffff</span>),</span><br><span class="line">        GDT_STACK_CANARY_INIT</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; &#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到每個entry都是人工刻上去的…在linux上GDT總共只有32個entry，在這32個當中有11個是沒在用的，如下圖：</p>
<p><img src="/images/linux_GDT.jpg" alt=""></p>
<p>接下來講GDT的每個entry，GDT的entry就是8 byte的descriptor，在這八個byte裡存的資料是segment的起始位置、大小，細到dpl這種只有一個bit的資訊。在舊版的linux kernel中，descriptor的宣告就只有很簡單的兩個int，但目前的版本有將每個欄位化分出來，每個欄位都有移個變數可以控制，因此為了調和這兩種新舊的宣告方式，在現在的linux kernel使用union，讓兩種宣告方式都行的通。</p>
<ul>
<li><p>union<br>union的member所佔的記憶體空間是相同的，這邊做個小實驗：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">data</span></span></span><br><span class="line">&#123;</span><br><span class="line">    int a;</span><br><span class="line">    int b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">data</span> <span class="title">test</span>;</span></span><br><span class="line"></span><br><span class="line">    test.a = <span class="number">10</span>;</span><br><span class="line">    printf(<span class="string">"a = %d, b = %d\n"</span>, test.a, test.b);</span><br><span class="line"></span><br><span class="line">    test.b = <span class="number">99</span>;</span><br><span class="line">    printf(<span class="string">"a = %d, b = %d\n"</span>, test.a, test.b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這邊我宣告了union裡面有a,b兩個成員，當我assign值給a時看一下a跟b目前的值： </p>
<p><img src="/images/union_test.jpg" alt=""></p>
<p>上面為執行結果，從結果可以看出不管我assign給哪個member，令一個member都會輸出一樣的值，在union底下所有的member是共用記憶體區塊的。因此我們可以利用union來建構descriptor的兩種不一樣宣告方式，在union底下宣告兩種struct：(<a href="http://lxr.cpsc.ucalgary.ca/lxr/linux+v3.9/arch/x86/include/asm/desc_defs.h#L22" target="_blank" rel="external">原始碼</a>)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> desc_struct &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> a;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> b;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            u16 limit0;</span><br><span class="line">            u16 base0;</span><br><span class="line">            <span class="keyword">unsigned</span> base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">unsigned</span> limit: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"> __attribute__((packed));</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p></p><h3> Task State Segment </h3><br>Intel x86有提供Task State Segment(TSS)，當process要切換到另一個process時，必須把目前的暫存器的值存起來，這時可以將這些值存在Task State Segment。而在linux kernel每個processor只會有一個TSS，要呼叫時用TR selector選擇該processor的GDT裡的TSS descriptor，再從descriptor裡面的資訊找到segment：<p></p>
<p><img src="/images/tss.jpg" alt=""></p>
<p>TSS架構：</p>
<p><img src="/images/tss_struct.jpg" alt=""></p>
<p>接下來介紹兩種在linux kernel會看到但不常見的語法：</p>
<ul>
<li><p>typeof Operator<br>通常typeof是來看被宣告的變數是什麼型態，由於linux kernel的code非常長，要用某個變數時時常不曉得他在哪邊被宣告的，於是我們就直接用typeof來看遍數為什麼型態，甚至能用來宣告變數。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> e;</span><br><span class="line">__typeof__(e + <span class="number">1</span>) j;  <span class="comment">/* the same as declaring int j; */</span></span><br></pre></td></tr></table></figure>
<p>上面的j被宣告為與e相同型態。</p>
</li>
<li><p>Comma Expressions<br>在C語言裡所有的敘述都會有回傳值，Comma Expressions會由左邊先計算，回傳值為最右邊。考慮下列程式：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r = <span class="comment">(a, b, ..., c)</span>;</span><br></pre></td></tr></table></figure>
<p>則計算過程為:a;b;…;r = c</p>
</li>
</ul>
<p></p><h2> Paging Unit </h2><br>之前講到x86的位址轉換，會先由logical address經由segment unit轉為linear address，之後再轉成memory可以用的physical address，從linear address轉為physical address過程就是paging unit。下圖為page unit示意圖：<p></p>
<p><img src="/images/page_unit.jpg" alt="圖一"></p>
<p>linear address會被切成3段，結構如下：</p>
<p><img src="/images/linearaddress_struct.jpg" alt=""></p>
<p>最左邊10個bit是查directory用，中間的10個bit是查page table用，最後的12bit則是offset。page的概念是一堆linear address的集合，每一個page大小為固定；page table裡面每一個entry就對應到一個page；page directory裡面的每一個entry就對應到一個page table。page table(這邊指的是圖一中page table以及page directory，老師投影片中講的小寫page table就是在這邊用到，因為常常把table跟directory統稱為page table)固定有1024個entry，每個entry為4 byte，所以一個page table大小為4KB。</p>
<p>在電腦剛開機時，processor進入real mode，此時paging的機制沒有開啟，在進到protected時，必須把cr0暫存器的PG flag設定為1才會開啟page unit。</p>
<p><img src="/images/page_cr0.jpg" alt=""></p>
<p>當PG=0時，processor會直接把linear address當做physical address送出去。</p>

        </section>
        <hr/>
        <nav class="pagination" style="width:auto" role="pagination">
            
            <a data-pjax class="newer-posts" href="/2015/10/28/Applied-Cryptography-6/">← Prev Post</a>
            
            <a class="share-button" data-original-title title>Share this Post</a>
            
            <a data-pjax class="older-posts" href="/2015/10/25/The-Attack-and-Defense-of-Computers-5/">Next Post →</a>
            
        </nav>
        <br/>
        <br/>
        <section id="comment">
            <div id="comment-box"></div>
        </section>


    </article>
</main>


  
<footer class="site-footer">
    
    <div class="inner">
        <section class="copyright"><a href="/"></a> &copy; Justice Shadower 2014</section>
        <section class="poweredby">Published with <a target="_blank" href="http://hexo.io/">Hexo   </a> and Theme by <a target="_blank" href="https://github.com/yuche/hexo-theme-kael">Kael</a></section>
    </div>
</footer>
</div>
</div><!-- /scroller -->

</div><!-- /pusher -->
</div><!-- /container -->
</div>

<!-- Easter eggs -->

<div class="egg animated">
    <a id="close-button" href="#">X</a>
    <div class="block">
        <div class="loading">
            <span class="ball1"></span>
            <span class="ball2"></span>
        </div>
    </div>
</div>
  
<script src="//cdn.staticfile.org/jquery/1.11.0/jquery.min.js"></script>
<script>
    if (!window.jQuery) {
        var script = document.createElement('script');
        script.src = "/js/jquery.min.js";
        document.body.appendChild(script);
    }
</script>
<script type="text/javascript" src="/js/lib.js"></script>
<script type="text/javascript" src="/js/main.js"></script>




<script type="text/javascript">
    var disqus_shortname = 'EastL';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




</body>
</html>
