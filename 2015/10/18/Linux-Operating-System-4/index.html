<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Linux Operating System-4 | Justice Shadower</title>
  <meta name="description" content="This world around you is not what it seems." />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/component.css" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <meta name="generator" content="Justice Shadower">
  <script src="http://static.duoshuo.com/embed.js"></script>
  
  
  

  

</head>
<body>
<div class="container">
    <div class="mp-pusher" id="mp-pusher">
        <i id="scroll-up" class="fa fa-angle-up"></i>
        <nav id="mp-menu" class="mp-menu">
            <div class="mp-level">
                <a data-pjax class="back-home" style="font-size: 20px" href="/"><h2 ><i class="fa fa-home"></i>
                        Home</h2></a>
                <ul class="first-level">
                    <li>
                        <a class="fa fa-archive" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Archive</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-archive"></i>
                                Archive</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-archive" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/22/Applied-Cryptography-8/">Applied Cryptography-8</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/21/Linux-Operating-System-8/">Linux Operating System-8</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/15/Linux-Operating-System-7/">Linux Operating System-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/08/The-Attack-and-Defense-of-Computers-7/">The Attack and Defense of Computers-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/07/Applied-Cryptography-7/">Applied Cryptography-7</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/05/The-Attack-and-Defense-of-Computers-6/">The Attack and Defense of Computers-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/11/01/Linux-Operating-System-6/">Linux Operating System-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/28/Applied-Cryptography-6/">Applied Cryptography-6</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/26/Linux-Operating-System-5/">Linux Operating System-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/25/The-Attack-and-Defense-of-Computers-5/">The Attack and Defense of Computers-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/21/Applied-Cryptography-5/">Applied Cryptography-5</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/18/Linux-Operating-System-4/">Linux Operating System-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">The Attack and Defense of Computers-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/17/Applied-Cryptography-4/">Applied Cryptography-4</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/16/Linux-Operating-System-3/">Linux Operating System-3</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/15/Linux-Operating-System-2/">Linux Operating System-2</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/14/Linux-Operating-System-1/">Linux Operating System-1</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/">The Attack and Defense of Computers (1~3)</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/10/10/Applied-Cryptography-3/">Applied Cryptography-3</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/09/29/Applied-Cryptography-2/">Applied Cryptography-2</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/09/28/Applied-Cryptography-1/">Applied Cryptography-1</a>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-copy" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Categories</a>

                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-copy"></i>
                                Categories</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-category" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/Applied-Cryptography/">&nbsp;&nbsp;&nbsp;Applied Cryptography</a>
                                    <small>8</small>
                                </li>
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/Linux-Operating-System/">&nbsp;&nbsp;&nbsp;Linux Operating System</a>
                                    <small>8</small>
                                </li>
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/The-Attack-and-Defense-of-Computers/">&nbsp;&nbsp;&nbsp;The Attack and Defense of Computers</a>
                                    <small>5</small>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-tags" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Tags</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-tags"></i>
                                Tags</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-tag" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Applied-Cryptography/">&nbsp;&nbsp;&nbsp;Applied Cryptography</a>
                                    <small>8</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Linux-Operating-System/">&nbsp;&nbsp;&nbsp;Linux Operating System</a>
                                    <small>8</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/The-Attack-and-Defense-of-Computers/">&nbsp;&nbsp;&nbsp;The Attack and Defense of Computers</a>
                                    <small>5</small>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    
                    <li class="mp-pjax"><a class="fa fa-user" href="https://adl.tw/~eastl/">&nbsp;&nbsp;&nbsp;About me</a></li>
                    <li><a class="fa fa-github" href="https://github.com/EastL" target = "_blank">&nbsp;&nbsp;&nbsp;Github</a></li>

                </ul>

            </div>
        </nav>
        <div id="pjax">
            <div class="pjax-hidden" style="display: none">
                
                    <a  data-pjax href="/2015/11/22/Applied-Cryptography-8/">Applied Cryptography-8</a>
                
                    <a  data-pjax href="/2015/11/21/Linux-Operating-System-8/">Linux Operating System-8</a>
                
                    <a  data-pjax href="/2015/11/15/Linux-Operating-System-7/">Linux Operating System-7</a>
                
                    <a  data-pjax href="/2015/11/08/The-Attack-and-Defense-of-Computers-7/">The Attack and Defense of Computers-7</a>
                
                    <a  data-pjax href="/2015/11/07/Applied-Cryptography-7/">Applied Cryptography-7</a>
                
                    <a  data-pjax href="/2015/11/05/The-Attack-and-Defense-of-Computers-6/">The Attack and Defense of Computers-6</a>
                
                    <a  data-pjax href="/2015/11/01/Linux-Operating-System-6/">Linux Operating System-6</a>
                
                    <a  data-pjax href="/2015/10/28/Applied-Cryptography-6/">Applied Cryptography-6</a>
                
                    <a  data-pjax href="/2015/10/26/Linux-Operating-System-5/">Linux Operating System-5</a>
                
                    <a  data-pjax href="/2015/10/25/The-Attack-and-Defense-of-Computers-5/">The Attack and Defense of Computers-5</a>
                
                    <a  data-pjax href="/2015/10/21/Applied-Cryptography-5/">Applied Cryptography-5</a>
                
                    <a  data-pjax href="/2015/10/18/Linux-Operating-System-4/">Linux Operating System-4</a>
                
                    <a  data-pjax href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">The Attack and Defense of Computers-4</a>
                
                    <a  data-pjax href="/2015/10/17/Applied-Cryptography-4/">Applied Cryptography-4</a>
                
                    <a  data-pjax href="/2015/10/16/Linux-Operating-System-3/">Linux Operating System-3</a>
                
                    <a  data-pjax href="/2015/10/15/Linux-Operating-System-2/">Linux Operating System-2</a>
                
                    <a  data-pjax href="/2015/10/14/Linux-Operating-System-1/">Linux Operating System-1</a>
                
                    <a  data-pjax href="/2015/10/12/The-Attack-and-Defense-of-Computers-1-3/">The Attack and Defense of Computers (1~3)</a>
                
                    <a  data-pjax href="/2015/10/10/Applied-Cryptography-3/">Applied Cryptography-3</a>
                
                    <a  data-pjax href="/2015/09/29/Applied-Cryptography-2/">Applied Cryptography-2</a>
                
                    <a  data-pjax href="/2015/09/28/Applied-Cryptography-1/">Applied Cryptography-1</a>
                
                
                    <a data-pjax href="/categories/Applied-Cryptography/">&nbsp;&nbsp;Applied Cryptography</a>
                
                    <a data-pjax href="/categories/Linux-Operating-System/">&nbsp;&nbsp;Linux Operating System</a>
                
                    <a data-pjax href="/categories/The-Attack-and-Defense-of-Computers/">&nbsp;&nbsp;The Attack and Defense of Computers</a>
                
                
                    <a data-pjax href="/tags/Applied-Cryptography/">&nbsp;&nbsp;Applied Cryptography</a>
                
                    <a data-pjax href="/tags/Linux-Operating-System/">&nbsp;&nbsp;Linux Operating System</a>
                
                    <a data-pjax href="/tags/The-Attack-and-Defense-of-Computers/">&nbsp;&nbsp;The Attack and Defense of Computers</a>
                
                <a data-pjax class="fa fa-user" href="http://adl.tw/~eastl/" target="_blank">&nbsp;&nbsp;&nbsp;About me</a>
            </div>
            <nav class="nexus">
                <li  style="border-left: 1px solid #c6d0da;">
                    <a id="trigger" href="#"><i class="fa fa-bars"></i></a>
                </li>
                <li ><a id="nexus-back" data-pjax href="/">Justice Shadower</a></li>
                
                <div id="nav-container">
                    <div class="post-navbar" style="line-height: 63px;display:none">
                        <li id="navbar-title"><a href="#">Linux Operating System-4</a></li>
                        <li id="navbar-toc" style="border-left: none">
                            <a style="padding-right: 15px">
                                <span id="toc-content" >Introduction</span><i class="fa fa-chevron-down" ></i>
                            </a>
                            <div class="hidden-box">
                                <ul id="toc"></ul>
                            </div>
                        </li>
                    </div>
                </div>
                
            </nav>

            <div class="scroller">
            <div class="scroller-inner">


<!-- -->
<!--<body class="post-template">-->
<!---->
  

<main class="content" role="main">
    <article class="post" >
    <span class="post-meta">
                  <div class="tag-tile">
                      
                      
                      <a data-pjax href='/tags/Linux-Operating-System/' style='color:#D5D5D5'>Linux Operating System</a>
                      
                      
                  </div>
                <h1 class="post-title" style="margin: 14px 0;color:#50585D">Linux Operating System-4</h1>

                    <div class="post-meta">
                        Post on<span class="fa fa-clock-o"></span>
                        <time datetime="2015-10-18T09:11:21.000Z"
                              itemprop="datePublished">2015-10-18</time>
                    </div>
    </span>

        <section class="post-content">
            <p>來源：<a href="http://www.csie.ncu.edu.tw/~hsufh/COURSES/FALL2015/linuxLecture_3_9-2.ppt" target="_blank" rel="external">Introduction and Memory Addressing: Segmentation Unit (21 ~ 49, 72 ~ 83)</a></p>
<h2> Memory Addressing(x32) </h2>

<p>在進入主題之前，先來複習一下第一堂課講過的三種address：  </p>
<p></p><h6> Logical Addresses </h6><br>主要是由segment base address加上offset組成，segment base address會在segment register。  <p></p>
<p></p><h6> Linear Addresses </h6><br>又稱做Virtual Address，主要是在logical轉換成實體位置之前的過度位址，有4G byte。  <p></p>
<p></p><h6> Physical Address </h6><br>最後的實體位置，對應著實際的memory cell，每個cell長度為一byte。<p></p>
<p>當compiler在配置記憶體給變數時，都是配置logical的offset給變數，然後CPU在執行每行指令時，會將logical address經過Segmentation Unit變成linear address，然後在經由Paging Unit變為最後的實體位置。</p>
<p><img src="/images/address_trans.jpg" alt=""></p>
<p>上圖為Address Translation過程，這邊注意的是這些轉換過程都是寫在CPU電路上的，並不是我們寫程式去執行的。在memory中有可能會有兩個processor同時要去存取同一塊記憶體，因此有Memory Arbitrator機制來保證不會發生此狀況。<br>接著開始進入Segmentation Unit，Segmentation Unit是在intel processor的protected mode底下addressing的機制，透過logical address 的 16bit segment selector以及32 bit 的 offset來計算出linear address。16 bit 的segment selector存在於segment register，IA-32 processor的segment register有六種，其中常用的為cs(code段用)、ds(data段用)，而segment selector的16個bit結構如下：</p>
<p><img src="/images/segment_selector.jpg" alt=""></p>
<p>最右邊兩個bit是RPL(Request Privilege Level)，代表著執行權限，有分為kernel權限(00)以及user權限(11)。cs暫存器中的RPL稱做CPL(Current Privilege Level)，代表著目前執行的process所擁有的執行權限。從logical address轉到linear address時，processer會透過segment selector來找到該位址的segment base，再將offset加上這個base address便是完整的linear address，而這些segment會用一種方式將他儲存在Descriptor中，這些Descriptors又會放在table裡面，所以當processor要去找相對應的segment需要先找到table，然後再去找table裡面的某個欄位才會是processor要的segment descriptor。中間的TI(Table Indicator)就是用來辨認這一次要找的segment base要去哪個table找，而最前面剩下的13個bit就是描述table的第幾欄位(index)。</p>
<p>講了這麼多，到底什麼是Descriptor，而這些Descriptor又放在什麼table呢？</p>
<ul>
<li><p>Segment Descriptor </p>
<p>為了方便管理記憶體，將記憶體切成一個區塊一個區塊，每個區塊叫做segment。而每個區塊的起始位置以及大小等資訊都會用 Descriptor 來記錄， Descriptor 大小為 8 byte：</p>
<ul>
<li>Base field (32): the linear address of the first byte of the segment.</li>
<li>G granularity flag (1): 0 (byte); 1 (4K bytes).</li>
<li>Limit field (20).</li>
<li>S system flag (1): 0 (system segment); 1 (normal segment).</li>
<li>Type field (4): segment type and its access rights.</li>
<li>DPL (Descriptor privilege level) (2):</li>
<li>Segment-present flag</li>
<li>D/B flag</li>
<li>Reserved bit</li>
<li>AVL flag</li>
</ul>
<p>DPL是表示此segment的執行權限，CPU查到此segment時，會將這個Descriptor的DPL跟segment register的CPL做比對，來看目前是否有權限執行。而Segment Descriptor又分為以下幾種：</p>
<ul>
<li>Code Segment Descriptor</li>
<li>Data Segment Descriptor</li>
<li>Task State Segment Descriptor </li>
<li>Local Descriptor Table Descriptor </li>
</ul>
<p>Task State Segment Descriptor(TSSD)是用在process切換時，儲存睡眠的proces暫存器狀態。下圖是Segment Descriptors的實際結構圖：</p>
<p><img src="/images/segment_descriptor.jpg" alt=""></p>
</li>
<li><p>GDT v.s. LDT</p>
<p>Segment Descriptors 會存在Global Descriptor Table (GDT) 或者Local Descriptor Table (LDT)這兩個table當中。在GDT裡面儲存的Descriptors是所有process都能夠使用的，所以一顆CPU只會有一個GDT；而LDT則是給各別的process使用，process無法存取別人的LDT。GDT的起始位置會存在gdtr暫存器裡，gdtr是32 bit的linear address以及16 bit的 table 大小：</p>
<p><img src="/images/gdtr.jpg" alt=""></p>
<p>而LDT的起始位置是存在ldtr當中：</p>
<p><img src="/images/ldtr.jpg" alt=""></p>
</li>
</ul>
<p>由於Segment Selector 的index只有13個bit，因此GDT最多只能有<span>$2^{13}$</span><!-- Has MathJax -->個entry，GDT的index最小從0開始。接下來看Intel processor如何將logical address轉換成linear address的：</p>
<p><img src="/images/trans_address.jpg" alt=""></p>
<p>透過selector找到相對應的GDT或LDT後，根據index找到descriptor，再從descriptor裡面找到base address，然後跟offset相加就得到linear address啦！</p>
<p></p><h2> Segmentation in Linux </h2><br>在linux kernel中他不想要用x86架構的segmentation，他讓所有的segment的起始位置都是00000000，所有的segment大小都是ffffffff，因此每個segment都可以用到整個4G的記憶體空間。由於每個segment的base都是00000000，因此在linux底下的logical offset就是他的virtual address。下圖為linux的descriptor：<p></p>
<p><img src="/images/linux_dc.jpg" alt=""></p>
<ul>
<li>Privilege Level Change<br>cs暫存器的RPL如果換成了不同的mode其他ds或是ss暫存器也要跟著切換。</li>
</ul>
<p>剩下的linux GDT就到下次講比較完整。</p>

        </section>
        <hr/>
        <nav class="pagination" style="width:auto" role="pagination">
            
            <a data-pjax class="newer-posts" href="/2015/10/21/Applied-Cryptography-5/">← Prev Post</a>
            
            <a class="share-button" data-original-title title>Share this Post</a>
            
            <a data-pjax class="older-posts" href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">Next Post →</a>
            
        </nav>
        <br/>
        <br/>
        <section id="comment">
            <div id="comment-box"></div>
        </section>


    </article>
</main>


  
<footer class="site-footer">
    
    <div class="inner">
        <section class="copyright"><a href="/"></a> &copy; Justice Shadower 2014</section>
        <section class="poweredby">Published with <a target="_blank" href="http://hexo.io/">Hexo   </a> and Theme by <a target="_blank" href="https://github.com/yuche/hexo-theme-kael">Kael</a></section>
    </div>
</footer>
</div>
</div><!-- /scroller -->

</div><!-- /pusher -->
</div><!-- /container -->
</div>

<!-- Easter eggs -->

<div class="egg animated">
    <a id="close-button" href="#">X</a>
    <div class="block">
        <div class="loading">
            <span class="ball1"></span>
            <span class="ball2"></span>
        </div>
    </div>
</div>
  
<script src="//cdn.staticfile.org/jquery/1.11.0/jquery.min.js"></script>
<script>
    if (!window.jQuery) {
        var script = document.createElement('script');
        script.src = "/js/jquery.min.js";
        document.body.appendChild(script);
    }
</script>
<script type="text/javascript" src="/js/lib.js"></script>
<script type="text/javascript" src="/js/main.js"></script>




<script type="text/javascript">
    var disqus_shortname = 'EastL';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
