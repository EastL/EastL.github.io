<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Linux Operating System-4 | Justice Shadower</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="來源：Introduction and Memory Addressing: Segmentation Unit (21 ~ 49, 72 ~ 83)
 Memory Addressing(x32) 

在進入主題之前，先來複習一下第一堂課講過的三種address：  
 Logical Addresses 主要是由segment base address加上offset組成，segment ba">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux Operating System-4">
<meta property="og:url" content="http://eastl.github.io/2015/10/18/Linux-Operating-System-4/index.html">
<meta property="og:site_name" content="Justice Shadower">
<meta property="og:description" content="來源：Introduction and Memory Addressing: Segmentation Unit (21 ~ 49, 72 ~ 83)
 Memory Addressing(x32) 

在進入主題之前，先來複習一下第一堂課講過的三種address：  
 Logical Addresses 主要是由segment base address加上offset組成，segment ba">
<meta property="og:image" content="http://eastl.github.io/images/address_trans.jpg">
<meta property="og:image" content="http://eastl.github.io/images/segment_selector.jpg">
<meta property="og:image" content="http://eastl.github.io/images/segment_descriptor.jpg">
<meta property="og:image" content="http://eastl.github.io/images/gdtr.jpg">
<meta property="og:image" content="http://eastl.github.io/images/ldtr.jpg">
<meta property="og:image" content="http://eastl.github.io/images/trans_address.jpg">
<meta property="og:image" content="http://eastl.github.io/images/linux_dc.jpg">
<meta property="og:updated_time" content="2015-10-21T12:52:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux Operating System-4">
<meta name="twitter:description" content="來源：Introduction and Memory Addressing: Segmentation Unit (21 ~ 49, 72 ~ 83)
 Memory Addressing(x32) 

在進入主題之前，先來複習一下第一堂課講過的三種address：  
 Logical Addresses 主要是由segment base address加上offset組成，segment ba">
<meta name="twitter:creator" content="@coolwuxing">
  
    <link rel="alternative" href="/atom.xml" title="Justice Shadower" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/cube.jpg">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-43935113-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <div id="header">
  <div id="banner">
    <div id="cover"></div>
    <div id="stars"></div>
  </div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Justice Shadower</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">This world around you is not what it seems.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://eastl.github.io"></form>
      </div>
    </div>
  </div>
</div>
      <div class="outer">
        <section id="main"><article id="post-Linux-Operating-System-4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/18/Linux-Operating-System-4/" class="article-date">
  <time datetime="2015-10-18T09:11:21.000Z" itemprop="datePublished">2015-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux Operating System-4
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>來源：<a href="http://www.csie.ncu.edu.tw/~hsufh/COURSES/FALL2015/linuxLecture_3_9-2.ppt" target="_blank" rel="external">Introduction and Memory Addressing: Segmentation Unit (21 ~ 49, 72 ~ 83)</a></p>
<h2> Memory Addressing(x32) </h2>

<p>在進入主題之前，先來複習一下第一堂課講過的三種address：  </p>
<p></p><h6> Logical Addresses </h6><br>主要是由segment base address加上offset組成，segment base address會在segment register。  <p></p>
<p></p><h6> Linear Addresses </h6><br>又稱做Virtual Address，主要是在logical轉換成實體位置之前的過度位址，有4G byte。  <p></p>
<p></p><h6> Physical Address </h6><br>最後的實體位置，對應著實際的memory cell，每個cell長度為一byte。<p></p>
<p>當compiler在配置記憶體給變數時，都是配置logical的offset給變數，然後CPU在執行每行指令時，會將logical address經過Segmentation Unit變成linear address，然後在經由Paging Unit變為最後的實體位置。</p>
<p><img src="/images/address_trans.jpg" alt=""></p>
<p>上圖為Address Translation過程，這邊注意的是這些轉換過程都是寫在CPU電路上的，並不是我們寫程式去執行的。在memory中有可能會有兩個processor同時要去存取同一塊記憶體，因此有Memory Arbitrator機制來保證不會發生此狀況。<br>接著開始進入Segmentation Unit，Segmentation Unit是在intel processor的protected mode底下addressing的機制，透過logical address 的 16bit segment selector以及32 bit 的 offset來計算出linear address。16 bit 的segment selector存在於segment register，IA-32 processor的segment register有六種，其中常用的為cs(code段用)、ds(data段用)，而segment selector的16個bit結構如下：</p>
<p><img src="/images/segment_selector.jpg" alt=""></p>
<p>最右邊兩個bit是RPL(Request Privilege Level)，代表著執行權限，有分為kernel權限(00)以及user權限(11)。cs暫存器中的RPL稱做CPL(Current Privilege Level)，代表著目前執行的process所擁有的執行權限。從logical address轉到linear address時，processer會透過segment selector來找到該位址的segment base，再將offset加上這個base address便是完整的linear address，而這些segment會用一種方式將他儲存在Descriptor中，這些Descriptors又會放在table裡面，所以當processor要去找相對應的segment需要先找到table，然後再去找table裡面的某個欄位才會是processor要的segment descriptor。中間的TI(Table Indicator)就是用來辨認這一次要找的segment base要去哪個table找，而最前面剩下的13個bit就是描述table的第幾欄位(index)。</p>
<p>講了這麼多，到底什麼是Descriptor，而這些Descriptor又放在什麼table呢？</p>
<ul>
<li><p>Segment Descriptor </p>
<p>為了方便管理記憶體，將記憶體切成一個區塊一個區塊，每個區塊叫做segment。而每個區塊的起始位置以及大小等資訊都會用 Descriptor 來記錄， Descriptor 大小為 8 byte：</p>
<ul>
<li>Base field (32): the linear address of the first byte of the segment.</li>
<li>G granularity flag (1): 0 (byte); 1 (4K bytes).</li>
<li>Limit field (20).</li>
<li>S system flag (1): 0 (system segment); 1 (normal segment).</li>
<li>Type field (4): segment type and its access rights.</li>
<li>DPL (Descriptor privilege level) (2):</li>
<li>Segment-present flag</li>
<li>D/B flag</li>
<li>Reserved bit</li>
<li>AVL flag</li>
</ul>
<p>DPL是表示此segment的執行權限，CPU查到此segment時，會將這個Descriptor的DPL跟segment register的CPL做比對，來看目前是否有權限執行。而Segment Descriptor又分為以下幾種：</p>
<ul>
<li>Code Segment Descriptor</li>
<li>Data Segment Descriptor</li>
<li>Task State Segment Descriptor </li>
<li>Local Descriptor Table Descriptor </li>
</ul>
<p>Task State Segment Descriptor(TSSD)是用在process切換時，儲存睡眠的proces暫存器狀態。下圖是Segment Descriptors的實際結構圖：</p>
<p><img src="/images/segment_descriptor.jpg" alt=""></p>
</li>
<li><p>GDT v.s. LDT</p>
<p>Segment Descriptors 會存在Global Descriptor Table (GDT) 或者Local Descriptor Table (LDT)這兩個table當中。在GDT裡面儲存的Descriptors是所有process都能夠使用的，所以一顆CPU只會有一個GDT；而LDT則是給各別的process使用，process無法存取別人的LDT。GDT的起始位置會存在gdtr暫存器裡，gdtr是32 bit的linear address以及16 bit的 table 大小：</p>
<p><img src="/images/gdtr.jpg" alt=""></p>
<p>而LDT的起始位置是存在ldtr當中：</p>
<p><img src="/images/ldtr.jpg" alt=""></p>
</li>
</ul>
<p>由於Segment Selector 的index只有13個bit，因此GDT最多只能有<span>$2^{13}$</span><!-- Has MathJax -->個entry，GDT的index最小從0開始。接下來看Intel processor如何將logical address轉換成linear address的：</p>
<p><img src="/images/trans_address.jpg" alt=""></p>
<p>透過selector找到相對應的GDT或LDT後，根據index找到descriptor，再從descriptor裡面找到base address，然後跟offset相加就得到linear address啦！</p>
<p></p><h2> Segmentation in Linux </h2><br>在linux kernel中他不想要用x86架構的segmentation，他讓所有的segment的起始位置都是00000000，所有的segment大小都是ffffffff，因此每個segment都可以用到整個4G的記憶體空間。由於每個segment的base都是00000000，因此在linux底下的logical offset就是他的virtual address。下圖為linux的descriptor：<p></p>
<p><img src="/images/linux_dc.jpg" alt=""></p>
<ul>
<li>Privilege Level Change<br>cs暫存器的RPL如果換成了不同的mode其他ds或是ss暫存器也要跟著切換。</li>
</ul>
<p>剩下的linux GDT就到下次講比較完整。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://eastl.github.io/2015/10/18/Linux-Operating-System-4/" data-id="cig2cw62j00084qon3b1suasp" class="article-share-link">Share</a>
      
        <a href="http://eastl.github.io/2015/10/18/Linux-Operating-System-4/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Operating-System/">Linux Operating System</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/10/21/Applied-Cryptography-5/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Applied Cryptography-5
        
      </div>
    </a>
  
  
    <a href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">The Attack and Defense of Computers-4</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Applied-Cryptography/">Applied Cryptography</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Operating-System/">Linux Operating System</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/The-Attack-and-Defense-of-Computers/">The Attack and Defense of Computers</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Applied-Cryptography/" style="font-size: 20px;">Applied Cryptography</a> <a href="/tags/Linux-Operating-System/" style="font-size: 15px;">Linux Operating System</a> <a href="/tags/The-Attack-and-Defense-of-Computers/" style="font-size: 10px;">The Attack and Defense of Computers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/10/21/Applied-Cryptography-5/">Applied Cryptography-5</a>
          </li>
        
          <li>
            <a href="/2015/10/18/Linux-Operating-System-4/">Linux Operating System-4</a>
          </li>
        
          <li>
            <a href="/2015/10/18/The-Attack-and-Defense-of-Computers-4/">The Attack and Defense of Computers-4</a>
          </li>
        
          <li>
            <a href="/2015/10/17/Applied-Cryptography-4/">Applied Cryptography-4</a>
          </li>
        
          <li>
            <a href="/2015/10/15/Linux-Operating-System-2/">Linux Operating System-2</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <div id="footer">
  
  <div id='foot-stars'></div>
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 EastL<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</div>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'EastL';
  
  var disqus_url = 'http://eastl.github.io/2015/10/18/Linux-Operating-System-4/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>